{% extends "base.html" %}
{% block title %}–°–∏–ª–ª–∞–±—É—Å {{ syllabus.course.code }}{% endblock %}
{% block content %}

<div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between mb-6">
  <div>
    <h1 class="text-2xl font-semibold">
      –°–∏–ª–ª–∞–±—É—Å {{ syllabus.course.code }} {{ syllabus.semester }}
    </h1>
    <p class="text-gray-600">{{ syllabus.course.display_title }}</p>
    <p class="text-gray-600">
      –ê–≤—Ç–æ—Ä: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}
    </p>
    <div class="flex items-center gap-2 mt-1">
        <p class="text-gray-700">–°—Ç–∞—Ç—É—Å:</p>
        <span class="badge badge--{{ syllabus.status }}">{{ syllabus.get_status_display }}</span>
    </div>
    <div class="mt-2 text-sm text-gray-500">
      <span class="mr-3">–í–µ—Ä—Å–∏—è: {{ syllabus.version_number }}</span>
      <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ syllabus.updated_at|date:"d.m.Y H:i" }}</span>
    </div>
  </div>

  <div class="flex flex-wrap gap-2">
    {% if can_edit_topics %}
      <a href="{% url 'syllabus_edit_details' syllabus.pk %}" class="btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã</a>
      <a href="{% url 'syllabus_edit_topics' syllabus.pk %}" class="btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã</a>
    {% endif %}
    <a href="{% url 'syllabus_pdf' syllabus.pk %}" class="btn-secondary">–°–∫–∞—á–∞—Ç—å PDF</a>
    {% if can_share %}
      <form method="post" action="{% url 'syllabus_toggle_share' syllabus.pk %}">
        {% csrf_token %}
        {% if syllabus.is_shared %}
          <button class="btn-secondary">–°–∫—Ä—ã—Ç—å –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</button>
        {% else %}
          <button class="btn-primary">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        {% endif %}
      </form>
    {% endif %}
  </div>
</div>

{% if can_send_ai %}
<div class="card p-5 mb-6 border-l-4 border-blue-500 bg-blue-50/30 shadow-sm">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
        <span>ü§ñ</span> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò
      </h3>
      <p class="text-slate-600 text-sm mt-1 max-w-2xl">
        –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å–∏–ª–ª–∞–±—É—Å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º AlmaU (–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ 15 –Ω–µ–¥–µ–ª—å, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã). –≠—Ç–æ –∑–∞–π–º–µ—Ç –æ–∫–æ–ª–æ 1 –º–∏–Ω—É—Ç—ã.
      </p>
    </div>
    <a href="{% url 'syllabus_send_ai' syllabus.pk %}" class="btn bg-blue-600 text-white hover:bg-blue-700 border-none shadow-md whitespace-nowrap px-6 py-2">
      <i class="fas fa-magic mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
    </a>
  </div>
</div>
{% endif %}

{% if syllabus.status == 'ai_check' %}
<div class="card p-5 mb-6 bg-amber-50 border-l-4 border-amber-500 shadow-sm">
  <div class="flex items-center gap-4">
    <svg class="animate-spin h-8 w-8 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <div>
      <div class="text-lg font-semibold text-amber-800">–ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò...</div>
      <div class="text-amber-700">
        –°–∏–ª–ª–∞–±—É—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ 
        <a href="" class="underline font-bold" onclick="window.location.reload();return false;">–æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</a> —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥.
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if syllabus.status == 'correction' and syllabus.ai_feedback %}
<div class="card p-5 mb-6 bg-red-50 border-l-4 border-red-500 shadow-sm">
  <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center gap-2">
    <i class="fas fa-exclamation-triangle"></i> –ó–∞–º–µ—á–∞–Ω–∏—è –ò–ò (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
  </h3>
  <div class="text-red-800 bg-white p-4 rounded border border-red-100 mb-3 whitespace-pre-line text-sm leading-relaxed shadow-inner">
    {{ syllabus.ai_feedback }}
  </div>
  <div class="flex gap-2">
    <a href="{% url 'syllabus_edit_topics' syllabus.pk %}" class="btn btn-sm bg-red-600 text-white hover:bg-red-700 border-none">
      –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–º—ã
    </a>
    <a href="{% url 'syllabus_edit_details' syllabus.pk %}" class="btn btn-sm bg-white text-red-700 border border-red-200 hover:bg-red-50">
      –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è
    </a>
  </div>
</div>
{% endif %}
<div class="card p-5 mb-6 status-rail">
  <div class="status-rail__header">
    <div>
      <div class="page-kicker">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</div>
      <div class="status-rail__title">–ü—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
      <div class="text-sm text-slate-600">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏.</div>
    </div>
    <span class="status-pill status-pill--{{ syllabus.status }}">{{ syllabus.get_status_display }}</span>
  </div>
  <div class="status-steps">
    <div class="status-step{% if syllabus.status == 'draft' or syllabus.status == 'correction' %} is-active{% elif syllabus.status != 'draft' and syllabus.status != 'correction' %} is-done{% endif %}">
      <div class="status-step__badge">1</div>
      <div class="status-step__label">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</div>
      <div class="status-step__desc">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏.</div>
    </div>
    <div class="status-step{% if syllabus.status == 'ai_check' %} is-active{% elif syllabus.status != 'draft' and syllabus.status != 'correction' and syllabus.status != 'ai_check' %} is-done{% endif %}">
      <div class="status-step__badge">2</div>
      <div class="status-step__label">AI –ü—Ä–æ–≤–µ—Ä–∫–∞</div>
      <div class="status-step__desc">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å.</div>
    </div>
    <div class="status-step{% if syllabus.status == 'review_dean' %} is-active{% elif syllabus.status == 'review_umu' or syllabus.status == 'approved' %} is-done{% endif %}">
      <div class="status-step__badge">3</div>
      <div class="status-step__label">–î–µ–∫–∞–Ω</div>
      <div class="status-step__desc">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º —à–∫–æ–ª—ã.</div>
    </div>
    <div class="status-step{% if syllabus.status == 'review_umu' %} is-active{% elif syllabus.status == 'approved' %} is-done{% endif %}">
      <div class="status-step__badge">4</div>
      <div class="status-step__label">–£–ú–£</div>
      <div class="status-step__desc">–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤.</div>
    </div>
  </div>
  
  <div class="status-checklist mt-4 pt-4 border-t">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:</p>
    
    {% if has_topics %}
      <div class="status-check is-done">–¢–µ–º—ã –∏ –Ω–µ–¥–µ–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã</div>
    {% elif syllabus.pdf_file %}
      <div class="status-check is-optional">–¢–µ–º—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PDF)</div>
    {% else %}
      <div class="status-check is-missing">–¢–µ–º—ã –∏ –Ω–µ–¥–µ–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã</div>
    {% endif %}

    {% if syllabus.pdf_file %}
      <div class="status-check is-done">–§–∞–π–ª PDF –∑–∞–≥—Ä—É–∂–µ–Ω</div>
    {% else %}
      <div class="status-check is-optional">–§–∞–π–ª PDF –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π)</div>
    {% endif %}

    {% if syllabus.status == 'review_dean' or syllabus.status == 'review_umu' or syllabus.status == 'approved' %}
       <div class="status-check is-done">AI –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞</div>
    {% else %}
       <div class="status-check is-missing">AI –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞</div>
    {% endif %}
  </div>
</div>


<div class="callout mb-6">
  <div class="callout__badge">!</div>
  <div class="callout__text">
    {% if can_send_ai %}
      <strong>–í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ:</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É" –≤—ã—à–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ò–ò.
    {% elif syllabus.status == 'ai_check' %}
      <strong>–û–∂–∏–¥–∞–Ω–∏–µ:</strong> –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
    {% elif can_approve_dean %}
      <strong>–î–µ–π—Å—Ç–≤–∏–µ –î–µ–∫–∞–Ω–∞:</strong> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –ø—Ä–∏–º–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ (–∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ).
    {% elif can_approve_umu %}
      <strong>–î–µ–π—Å—Ç–≤–∏–µ –£–ú–£:</strong> –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.
    {% elif is_frozen %}
      –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞. –î–æ–∫—É–º–µ–Ω—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω.
    {% else %}
      –û–∂–∏–¥–∞–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–π —Å–æ–≥–ª–∞—Å—É—é—â–∏—Ö –ª–∏—Ü.
    {% endif %}
  </div>
</div>


{% if can_approve_dean or can_approve_umu or can_submit_umu or can_submit_dean %}
<div class="card p-5 mb-6 bg-gray-50 border border-gray-200">
  <h3 class="font-semibold mb-3">–ü–∞–Ω–µ–ª—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h3>
  <div class="flex flex-wrap gap-3">
    
    {% if can_approve_dean %}
      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'review_umu' %}" class="inline-flex items-center gap-2">
        {% csrf_token %}
        <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)" class="border rounded px-3 py-2 text-sm w-64">
        <button class="btn-primary">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –£–ú–£</button>
      </form>
      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'correction' %}" class="inline-flex items-center gap-2">
        {% csrf_token %}
        <input type="text" name="comment" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞" class="border rounded px-3 py-2 text-sm w-64" required>
        <button class="btn-secondary text-red-600 hover:bg-red-50">‚Ü© –í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</button>
      </form>
    {% endif %}

    {% if can_approve_umu %}
      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved' %}" class="inline-flex items-center gap-2">
        {% csrf_token %}
        <input type="text" name="comment" placeholder="–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border rounded px-3 py-2 text-sm w-64">
        <button class="btn-primary bg-green-600 hover:bg-green-700 border-none">üèÜ –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ</button>
      </form>
      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'correction' %}" class="inline-flex items-center gap-2">
        {% csrf_token %}
        <input type="text" name="comment" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è" class="border rounded px-3 py-2 text-sm w-64" required>
        <button class="btn-secondary text-red-600 hover:bg-red-50">üõë –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      </form>
    {% endif %}

  </div>
</div>
{% endif %}


{% if syllabus.pdf_file and not has_topics %}
  <div class="card p-4 mb-4">
    <div class="font-semibold">–°–∏–ª–ª–∞–±—É—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ PDF-—Ä–µ–∂–∏–º–µ</div>
    <p class="text-sm text-slate-600 mt-1">
      –¢–µ–º—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã ‚Äî –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π PDF.
    </p>
  </div>
{% endif %}

{% if syllabus.credits_ects or syllabus.total_hours or syllabus.contact_hours %}
  <div class="card p-5 mb-6">
    <h2 class="text-xl font-semibold mb-3">–ü–∞—Å–ø–æ—Ä—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</h2>
    <div class="grid gap-3 md:grid-cols-2 text-sm text-slate-700">
      {% if syllabus.credits_ects %}<div><span class="font-semibold">–ö—Ä–µ–¥–∏—Ç—ã (ECTS):</span> {{ syllabus.credits_ects }}</div>{% endif %}
      {% if syllabus.total_hours %}<div><span class="font-semibold">–í—Å–µ–≥–æ —á–∞—Å–æ–≤:</span> {{ syllabus.total_hours }}</div>{% endif %}
      {% if syllabus.contact_hours %}<div><span class="font-semibold">–ê—É–¥–∏—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã:</span> {{ syllabus.contact_hours }}</div>{% endif %}
      {% if syllabus.instructor_name %}<div><span class="font-semibold">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</span> {{ syllabus.instructor_name }}</div>{% endif %}
    </div>
  </div>
{% endif %}


<h2 class="text-xl font-semibold mb-2">–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω</h2>
<div class="card overflow-hidden">
  <table class="table w-full">
    <thead class="bg-slate-50">
      <tr class="border-b">
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–ù–µ–¥–µ–ª—è</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–¢–µ–º–∞</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–ó–∞–¥–∞–Ω–∏—è</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</th>
      </tr>
    </thead>
    <tbody class="divide-y">
      {% for st in topics %}
        <tr class="hover:bg-slate-50/50">
          <td class="p-3 text-sm font-medium text-slate-700 w-24">
              {{ st.week_label|default:st.week_number }}
          </td>
          <td class="p-3">
            <div class="font-medium text-slate-800">{{ st.get_title }}</div>
            <div class="text-xs text-slate-500 mt-1">
              {{ st.topic.get_week_type_display }} ‚Ä¢ {{ st.custom_hours|default:st.topic.default_hours }} —á.
            </div>
          </td>
          <td class="p-3 text-sm text-slate-600">
            {{ st.tasks|default:"-"|truncatechars:50 }}
          </td>
          <td class="p-3 text-sm text-slate-600">
             {% if st.topic.literature.exists %}
                <span class="badge">–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {{ st.topic.literature.count }}</span>
             {% else %}
                <span class="text-red-400 text-xs">–ù–µ—Ç –ª–∏—Ç-—Ä—ã</span>
             {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="p-6 text-center text-slate-500">
            –¢–µ–º—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã. <a href="{% url 'syllabus_edit_topics' syllabus.pk %}" class="link">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–π—á–∞—Å</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if syllabus.revisions.exists %}
<div class="mt-8">
    <details class="group">
        <summary class="flex items-center gap-2 cursor-pointer font-semibold text-slate-600">
            <span>üïò –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –ª–æ–≥–∏</span>
            <span class="transition group-open:rotate-180">‚ñº</span>
        </summary>
        <div class="mt-4 card divide-y">
            {% for revision in syllabus.revisions.all %}
            <div class="px-4 py-2 text-sm flex justify-between">
                <div>
                    <span class="font-bold">v{{ revision.version_number }}</span>
                    <span class="ml-2">{{ revision.note }}</span>
                </div>
                <div class="text-gray-400">{{ revision.created_at|date:"d.m.Y H:i" }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
</div>
{% endif %}

{% endblock %}