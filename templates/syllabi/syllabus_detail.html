{% extends "base.html" %}
{% block title %}–°–∏–ª–ª–∞–±—É—Å1 {{ syllabus.course.code }}{% endblock %}
"–¢–ï–°–¢123"
{% block content %}

<div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between mb-8 border-b pb-6">
  <div>
    <h1 class="text-3xl font-bold text-slate-800">
      {{ syllabus.course.code }}
    </h1>
    <p class="text-xl text-slate-600 mt-1">{{ syllabus.course.display_title }}</p>
    <div class="flex items-center gap-4 mt-3 text-sm text-slate-500">
        <span>{{ syllabus.semester }} / {{ syllabus.academic_year }}</span>
        <span>‚Ä¢</span>
        <span>–ê–≤—Ç–æ—Ä: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}</span>
        <span>‚Ä¢</span>
        <span>–í–µ—Ä—Å–∏—è: v{{ syllabus.version_number }}</span>
    </div>
  </div>

  <div class="flex flex-col items-end gap-3">
    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
        {% if syllabus.status == 'approved' %} bg-green-100 text-green-800
        {% elif syllabus.status == 'correction' %} bg-red-100 text-red-800
        {% elif syllabus.status == 'ai_check' %} bg-amber-100 text-amber-800
        {% else %} bg-slate-100 text-slate-800 {% endif %}">
        
        {% if syllabus.status == 'ai_check' %}
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        {% endif %}
        {{ syllabus.get_status_display }}
    </div>

    <div class="flex gap-2">
        {% if syllabus.pdf_file %}
            <a href="{{ syllabus.pdf_file.url }}" target="_blank" class="btn-secondary text-sm">
                üìÑ –°–∫–∞—á–∞—Ç—å PDF
            </a>
        {% endif %}
        
        {% if can_share %}
          <form method="post" action="{% url 'syllabus_toggle_share' syllabus.pk %}">
            {% csrf_token %}
            <button class="btn-secondary text-sm">
                {% if syllabus.is_shared %}üîí –°–∫—Ä—ã—Ç—å{% else %}üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è{% endif %}
            </button>
          </form>
        {% endif %}
    </div>
  </div>
</div>

{% if syllabus.status == 'ai_check' %}
<div class="mb-8 p-6 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-4 animate-pulse">
    <div class="text-3xl">ü§ñ</div>
    <div>
        <h3 class="text-lg font-semibold text-amber-900">–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç...</h3>
        <p class="text-amber-700 mt-1">–≠—Ç–æ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç 30 —Å–µ–∫—É–Ω–¥ –¥–æ 1 –º–∏–Ω—É—Ç—ã. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.</p>
        <div class="mt-3">
            <button onclick="window.location.reload()" class="text-sm font-bold underline text-amber-800 hover:text-amber-900">
                –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            </button>
        </div>
    </div>
</div>
{% endif %}

{% if syllabus.status == 'correction' and syllabus.ai_feedback %}
<div class="mb-8 p-6 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start gap-4">
        <div class="text-3xl text-red-500">‚ö†Ô∏è</div>
        <div class="flex-1">
            <h3 class="text-lg font-bold text-red-900 mb-2">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã</h3>
            <div class="bg-white p-4 rounded border border-red-100 text-red-800 text-sm whitespace-pre-line leading-relaxed shadow-sm">
                {{ syllabus.ai_feedback }}
            </div>
            <p class="mt-4 text-red-800 font-medium">
                üëá –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ (Word/PDF) –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ –∑–∞–Ω–æ–≤–æ –Ω–∏–∂–µ.
            </p>
        </div>
    </div>
</div>
{% endif %}


{% if can_upload %}
<div class="mb-8 bg-white border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-400 transition group">
    <h3 class="text-lg font-semibold text-slate-800 mb-2">
        {% if syllabus.status == 'correction' %}
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        {% else %}
            –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª —Å–∏–ª–ª–∞–±—É—Å–∞
        {% endif %}
    </h3>
    <p class="text-slate-500 mb-6 max-w-md mx-auto">
        –í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Ñ–∞–π–ª–∞. 
        –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É.
    </p>
    
    <form action="{% url 'syllabus_upload_file' pk=syllabus.pk %}" method="post" enctype="multipart/form-data" class="inline-block">
        {% csrf_token %}
        <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg shadow-md transition transform hover:-translate-y-0.5 inline-flex items-center gap-2">
            <span>üì§ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (PDF/Word)</span>
            <input type="file" name="attachment" class="hidden" onchange="this.form.submit()" accept=".pdf,.docx,.doc">
        </label>
    </form>
    <p class="text-xs text-slate-400 mt-4">–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏.</p>
</div>
{% endif %}


{% if can_approve_dean or can_approve_umu or can_submit_umu or can_submit_dean %}
<div class="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-lg">
    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
    <div class="flex flex-wrap gap-4">
        
        {% if can_approve_dean %}
            <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'review_umu' %}" class="flex gap-2">
                {% csrf_token %}
                <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-medium">
                    ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å (–≤ –£–ú–£)
                </button>
            </form>
            <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'correction' %}" class="flex gap-2">
                {% csrf_token %}
                <input type="text" name="comment" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞..." class="border rounded px-3 py-2 text-sm" required>
                <button class="bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50">
                    –í–µ—Ä–Ω—É—Ç—å
                </button>
            </form>
        {% endif %}

        {% if can_approve_umu %}
            <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved' %}" class="flex gap-2">
                {% csrf_token %}
                <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium shadow-sm">
                    üèÜ –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ
                </button>
            </form>
            <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'correction' %}" class="flex gap-2">
                {% csrf_token %}
                <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="border rounded px-3 py-2 text-sm" required>
                <button class="bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50">
                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                </button>
            </form>
        {% endif %}
    </div>
</div>
{% endif %}


{% if syllabus.revisions.exists %}
<div class="border-t pt-6 mb-8">
    <details class="group">
        <summary class="list-none flex items-center gap-2 cursor-pointer text-slate-500 hover:text-slate-800 font-medium transition">
            <span>üïò –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫</span>
            <span class="text-xs transition-transform group-open:rotate-180">‚ñº</span>
        </summary>
        <div class="mt-4 overflow-hidden rounded-lg border border-slate-200">
            <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-500 font-medium">
                    <tr>
                        <th class="px-4 py-2">–í–µ—Ä—Å–∏—è</th>
                        <th class="px-4 py-2">–î–µ–π—Å—Ç–≤–∏–µ</th>
                        <th class="px-4 py-2">–ê–≤—Ç–æ—Ä</th>
                        <th class="px-4 py-2 text-right">–î–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for revision in syllabus.revisions.all %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 font-mono text-slate-600">v{{ revision.version_number }}</td>
                        <td class="px-4 py-2 text-slate-800">{{ revision.note }}</td>
                        <td class="px-4 py-2 text-slate-600">{{ revision.changed_by.get_full_name }}</td>
                        <td class="px-4 py-2 text-right text-slate-500">{{ revision.created_at|date:"d.m H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
</div>
{% endif %}


{% if has_topics %}
<h2 class="text-xl font-semibold mb-4 text-slate-800">–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω</h2>
<div class="card overflow-hidden border border-slate-200 rounded-lg">
  <table class="table w-full">
    <thead class="bg-slate-50">
      <tr class="border-b">
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–ù–µ–¥–µ–ª—è</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–¢–µ–º–∞</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–ó–∞–¥–∞–Ω–∏—è</th>
        <th class="p-3 text-left text-sm font-semibold text-slate-600">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-100">
      {% for st in topics %}
        <tr class="hover:bg-slate-50/50">
          <td class="p-3 text-sm font-medium text-slate-700 w-24">
              {{ st.week_label|default:st.week_number }}
          </td>
          <td class="p-3">
            <div class="font-medium text-slate-800">{{ st.get_title }}</div>
            <div class="text-xs text-slate-500 mt-1">
              {{ st.topic.get_week_type_display }} ‚Ä¢ {{ st.custom_hours|default:st.topic.default_hours }} —á.
            </div>
          </td>
          <td class="p-3 text-sm text-slate-600">
            {{ st.tasks|default:"-"|truncatechars:50 }}
          </td>
          <td class="p-3 text-sm text-slate-600">
             {% if st.topic.literature.exists %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {{ st.topic.literature.count }}
                </span>
             {% else %}
                <span class="text-red-400 text-xs">–ù–µ—Ç –ª–∏—Ç-—Ä—ã</span>
             {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

{% if syllabus.pdf_file and not has_topics %}
  <div class="p-8 mb-6 text-center bg-slate-50 border border-slate-100 rounded-lg">
    <div class="text-4xl mb-3">üìÑ</div>
    <h3 class="text-lg font-semibold text-slate-800">–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–∞</h3>
    <p class="text-slate-600 mt-2 max-w-md mx-auto text-sm">
      –°–∏–ª–ª–∞–±—É—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ PDF. –¢–µ–º—ã –Ω–µ –±—ã–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    </p>
    <a href="{{ syllabus.pdf_file.url }}" class="mt-4 inline-block px-4 py-2 bg-white border border-slate-300 rounded hover:bg-slate-50 text-slate-700 text-sm font-medium transition" target="_blank">
        –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
    </a>
  </div>
{% endif %}

{% endblock %}