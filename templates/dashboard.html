{% extends "base.html" %}
{% block title %}Панель управления{% endblock %}
{% block body_class %}dashboard-page{% endblock %}
{% block content %}
<div class="dashboard">
  <div class="dashboard__main">
<div class="mb-6">
  <h1 class="text-3xl font-bold">Панель управления — {{ user.get_role_display }}</h1>
  <p class="text-gray-600 mt-2">
    {% if user.role == "teacher" or user.role == "program_leader" %}
      Управляйте курсами, темами и силлабусами в едином пространстве AlmaU.
    {% elif user.role == "dean" %}
      Просматривайте силлабусы на согласовании и принимайте решения как декан.
    {% elif user.role == "umu" %}
      Финальное согласование силлабусов и контроль качества в УМУ.
    {% else %}
      Административная панель управления системой и процессом согласования.
    {% endif %}
  </p>
</div>

{% if user.can_view_courses or user.can_view_shared_courses %}
  <div class="dashboard-grid">
    {% if user.can_view_courses %}
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Мои курсы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Создавайте и редактируйте курсы, ведите банк тем и материалов.
        </p>
        <span class="text-sm text-gray-500">{{ my_courses_count }} курс(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'courses_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
    {% endif %}

    {% if user.can_view_shared_courses %}
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Общие курсы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Используйте общие курсы коллег как основу и адаптируйте под себя.
        </p>
        <span class="text-sm text-gray-500">{{ shared_courses_count }} курс(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'shared_courses_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
    {% endif %}

    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Мои силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Собирайте силлабусы на семестр и отправляйте на согласование.
        </p>
        <span class="text-sm text-gray-500">{{ syllabi_count }} силлабус(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'syllabi_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>

    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Общие силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Просматривайте силлабусы по похожим дисциплинам коллег.
        </p>
        <span class="text-sm text-gray-500">{{ shared_syllabi_count }} силлабус(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'shared_syllabi_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
  </div>

  <div class="card p-5">
    <h2 class="text-xl font-semibold mb-3">Первые шаги</h2>
    <ol class="list-decimal ml-6 text-slate-600 space-y-2">
      <li>Создайте курс и заполните банк тем (названия, часы, литература).</li>
      <li>Загрузите готовый файл силлабуса (PDF/Word) для автоматической проверки.</li>
      <li>Проверьте отчет ИИ и отправьте документ на согласование.</li>
    </ol>
    {% if user.can_view_courses %}
      <div class="flex flex-wrap gap-2 mt-4">
        <a href="{% url 'course_create' %}" class="btn-primary">Создать курс</a>
        <a href="{% url 'upload_pdf' %}" class="btn-secondary">Загрузить силлабус</a>
      </div>
    {% endif %}
  </div>
{% else %}
  <div class="dashboard-grid">
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Все силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Просматривайте силлабусы по всем курсам и управляйте статусами.
        </p>
      </div>
      <div class="mt-4">
        <a href="{% url 'syllabi_list' %}" class="btn-primary inline-block">Открыть список</a>
      </div>
    </div>

    {% if user.can_view_shared_courses %}
      <div class="card p-5 flex flex-col justify-between">
        <div>
          <h2 class="text-xl font-semibold mb-2">Общие курсы</h2>
          <p class="text-gray-600 text-sm mb-3">
            Смотрите базы тем и материалов для согласования.
          </p>
        </div>
        <div class="mt-4">
          <a href="{% url 'shared_courses_list' %}" class="btn-secondary inline-block">Открыть</a>
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}

  <div class="card p-5 approval-board">
    <div class="approval-board__header">
      <div>
        <h2 class="text-xl font-semibold">Согласование</h2>
        <p class="text-sm text-slate-600">Все статусы и решения по силлабусам собраны в одном месте.</p>
      </div>
      <div class="status-legend">
        <span class="status-pill status-pill--approved_umu">Утверждено</span>
        <span class="status-pill status-pill--rejected">Отклонено</span>
      </div>
    </div>

    {% if my_reviews or pending_dean or pending_umu %}
      <div class="approval-grid">
        {% if my_reviews %}
          <div class="approval-section">
            <div class="approval-section__title">Мои заявки</div>
            <div class="approval-list">
              {% for syllabus in my_reviews %}
                <div class="approval-item">
                  <div>
                    <div class="approval-item__title">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
                    <div class="approval-item__meta">{{ syllabus.course.display_title }}</div>
                  </div>
                  <span class="status-pill status-pill--{{ syllabus.status }}">{{ syllabus.get_status_display }}</span>
                  <div class="approval-actions">
                    <a href="{% url 'syllabus_detail' syllabus.pk %}" class="link">Открыть</a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if pending_dean %}
          <div class="approval-section">
            <div class="approval-section__title">На согласовании у декана</div>
            <div class="approval-list">
              {% for syllabus in pending_dean %}
                <div class="approval-item">
                  <div>
                    <div class="approval-item__title">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
                    <div class="approval-item__meta">
                      Автор: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}
                    </div>
                  </div>
                  <span class="status-pill status-pill--{{ syllabus.status }}">{{ syllabus.get_status_display }}</span>
                  <div class="approval-actions">
                    <a href="{% url 'syllabus_detail' syllabus.pk %}" class="btn-secondary">Открыть</a>
                    {% if syllabus.creator != user %}
                      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved_dean' %}" class="approval-action-form">
                        {% csrf_token %}
                        <input type="text" name="comment" placeholder="Комментарий" class="approval-input">
                        <button class="btn-primary">Утвердить</button>
                      </form>
                      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'rejected' %}" class="approval-action-form">
                        {% csrf_token %}
                        <input type="text" name="comment" placeholder="Причина отклонения" class="approval-input" required>
                        <button class="btn-secondary">Отклонить</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if pending_umu %}
          <div class="approval-section">
            <div class="approval-section__title">На согласовании в УМУ</div>
            <div class="approval-list">
              {% for syllabus in pending_umu %}
                <div class="approval-item">
                  <div>
                    <div class="approval-item__title">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
                    <div class="approval-item__meta">
                      Автор: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}
                    </div>
                  </div>
                  <span class="status-pill status-pill--{{ syllabus.status }}">{{ syllabus.get_status_display }}</span>
                  <div class="approval-actions">
                    <a href="{% url 'syllabus_detail' syllabus.pk %}" class="btn-secondary">Открыть</a>
                    {% if syllabus.creator != user %}
                      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved_umu' %}" class="approval-action-form">
                        {% csrf_token %}
                        <input type="text" name="comment" placeholder="Комментарий" class="approval-input">
                        <button class="btn-primary">Финально утвердить</button>
                      </form>
                      <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'rejected' %}" class="approval-action-form">
                        {% csrf_token %}
                        <input type="text" name="comment" placeholder="Причина отклонения" class="approval-input" required>
                        <button class="btn-secondary">Отклонить</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <p class="text-sm text-slate-500">Нет документов на согласовании.</p>
    {% endif %}
  </div>
  </div>
  <aside class="dashboard__aside">
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Объявления</h2>
        <span class="badge">Декан / УМУ</span>
      </div>
      {% if can_manage_announcements %}
        <details class="announcement-compose">
          <summary>Новая публикация</summary>
          <form method="post" action="{% url 'announcement_create' %}" class="announcement-form">
            {% csrf_token %}
            {{ announcement_form.non_field_errors }}
            <div class="announcement-field">
              <label for="{{ announcement_form.title.id_for_label }}">Заголовок</label>
              {{ announcement_form.title.errors }}
              {{ announcement_form.title }}
            </div>
            <div class="announcement-field">
              <label for="{{ announcement_form.body.id_for_label }}">Текст</label>
              {{ announcement_form.body.errors }}
              {{ announcement_form.body }}
            </div>
            <button class="btn-primary">Опубликовать</button>
          </form>
        </details>
      {% endif %}

      {% if announcements %}
        <div class="announcement-list">
          {% for item in announcements %}
            <article class="announcement-item">
              <div class="announcement-title">{{ item.title }}</div>
              <div class="announcement-meta">
                {{ item.created_at|date:"d.m.Y H:i" }}
                {% if item.created_by %}
                  • {{ item.created_by.get_full_name|default:item.created_by.username }}
                {% endif %}
              </div>
              <div class="announcement-body">{{ item.body|linebreaksbr }}</div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="announcement-empty">
          Публикаций пока нет. Новые объявления появятся здесь.
        </div>
      {% endif %}
    </div>
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Уведомления</h2>
      </div>
      <div class="rounded-lg border border-slate-200/70 bg-white/80 p-3 text-sm text-slate-600">
        Здесь будут напоминания по задачам, дедлайнам и статусам согласования.
      </div>
    </div>
  </aside>
</div>
{% endblock %}