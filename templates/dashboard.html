{% extends "base.html" %}
{% block title %}Панель управления{% endblock %}
{% block body_class %}dashboard-page{% endblock %}
{% block content %}
<div class="dashboard">
  <div class="dashboard__main">
<div class="mb-6">
  <h1 class="text-3xl font-bold">Панель управления — {{ user.get_role_display }}</h1>
  <p class="text-gray-600 mt-2">
    {% if user.role == "teacher" or user.role == "program_leader" %}
      Управляйте курсами, темами и силлабусами в едином пространстве AlmaU.
    {% elif user.role == "dean" %}
      Просматривайте силлабусы на согласовании и принимайте решения как декан.
    {% elif user.role == "umu" %}
      Финальное согласование силлабусов и контроль качества в УМУ.
    {% else %}
      Административная панель управления системой и процессом согласования.
    {% endif %}
  </p>
</div>

{% if user.can_view_courses or user.can_view_shared_courses %}
  <div class="dashboard-grid">
    {% if user.can_view_courses %}
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Мои курсы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Создавайте и редактируйте курсы, ведите банк тем и материалов.
        </p>
        <span class="text-sm text-gray-500">{{ my_courses_count }} курс(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'courses_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
    {% endif %}

    {% if user.can_view_shared_courses %}
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Общие курсы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Используйте общие курсы коллег как основу и адаптируйте под себя.
        </p>
        <span class="text-sm text-gray-500">{{ shared_courses_count }} курс(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'shared_courses_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
    {% endif %}

    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Мои силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Собирайте силлабусы на семестр и отправляйте на согласование.
        </p>
        <span class="text-sm text-gray-500">{{ syllabi_count }} силлабус(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'syllabi_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>

    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Общие силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Просматривайте силлабусы по похожим дисциплинам коллег.
        </p>
        <span class="text-sm text-gray-500">{{ shared_syllabi_count }} силлабус(ов)</span>
      </div>
      <div class="mt-4">
        <a href="{% url 'shared_syllabi_list' %}" class="btn-primary inline-block">Открыть</a>
      </div>
    </div>
  </div>

  <div class="card p-5">
    <h2 class="text-xl font-semibold mb-3">Первые шаги</h2>
    <ol class="list-decimal ml-6 text-slate-600 space-y-2">
      <li>Создайте курс и заполните банк тем (названия, часы, литература).</li>
      <li>Соберите силлабус на семестр или загрузите старый PDF для ориентира.</li>
      <li>Проверьте недели, часы и отправьте на согласование.</li>
    </ol>
    {% if user.can_view_courses %}
      <div class="flex flex-wrap gap-2 mt-4">
        <a href="{% url 'course_create' %}" class="btn-primary">Создать курс</a>
        <a href="{% url 'syllabus_create' %}" class="btn-secondary">Создать силлабус</a>
        <a href="{% url 'syllabus_create' %}#upload" class="btn-secondary">Загрузить PDF</a>
      </div>
    {% endif %}
  </div>

  <div class="card p-5">
    <h2 class="text-xl font-semibold mb-3">Мои заявки на согласование</h2>
    {% if my_reviews %}
      <div class="space-y-3">
        {% for syllabus in my_reviews %}
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between border-b pb-2">
            <div>
              <div class="font-medium">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
              <div class="text-sm text-slate-500">{{ syllabus.get_status_display }}</div>
            </div>
            <a href="{% url 'syllabus_detail' syllabus.pk %}" class="link">Открыть</a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-slate-500">Пока нет заявок на согласование.</p>
    {% endif %}
  </div>
{% else %}
  <div class="dashboard-grid">
    <div class="card p-5 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Все силлабусы</h2>
        <p class="text-gray-600 text-sm mb-3">
          Просматривайте силлабусы по всем курсам и управляйте статусами.
        </p>
      </div>
      <div class="mt-4">
        <a href="{% url 'syllabi_list' %}" class="btn-primary inline-block">Открыть список</a>
      </div>
    </div>

    {% if user.can_view_shared_courses %}
      <div class="card p-5 flex flex-col justify-between">
        <div>
          <h2 class="text-xl font-semibold mb-2">Общие курсы</h2>
          <p class="text-gray-600 text-sm mb-3">
            Смотрите базы тем и материалов для согласования.
          </p>
        </div>
        <div class="mt-4">
          <a href="{% url 'shared_courses_list' %}" class="btn-secondary inline-block">Открыть</a>
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}

{% if user.role == "dean" or user.role == "admin" %}
  <div class="card p-5">
    <h2 class="text-xl font-semibold mb-3">На согласовании у декана</h2>
    {% if pending_dean %}
      <div class="space-y-3">
        {% for syllabus in pending_dean %}
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between border-b pb-2">
            <div>
              <div class="font-medium">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
              <div class="text-sm text-slate-500">
                Автор: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <a href="{% url 'syllabus_detail' syllabus.pk %}" class="btn-secondary">Открыть</a>
              {% if user.role == "admin" or user.role == "dean" and syllabus.creator != user %}
                <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved_dean' %}" class="inline-flex items-center gap-2">
                  {% csrf_token %}
                  <input type="text" name="comment" placeholder="Комментарий" class="border rounded px-2 py-1 text-sm">
                  <button class="btn-primary">Утвердить</button>
                </form>
                <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'rejected' %}" class="inline-flex items-center gap-2">
                  {% csrf_token %}
                  <input type="text" name="comment" placeholder="Причина отклонения" class="border rounded px-2 py-1 text-sm" required>
                  <button class="btn-secondary">Отклонить</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-slate-500">Нет заявок на согласовании.</p>
    {% endif %}
  </div>
{% endif %}

{% if user.role == "umu" or user.role == "admin" %}
  <div class="card p-5">
    <h2 class="text-xl font-semibold mb-3">На согласовании в УМУ</h2>
    {% if pending_umu %}
      <div class="space-y-3">
        {% for syllabus in pending_umu %}
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between border-b pb-2">
            <div>
              <div class="font-medium">{{ syllabus.course.code }} {{ syllabus.semester }}</div>
              <div class="text-sm text-slate-500">
                Автор: {{ syllabus.creator.get_full_name|default:syllabus.creator.username }}
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <a href="{% url 'syllabus_detail' syllabus.pk %}" class="btn-secondary">Открыть</a>
              {% if user.role == "admin" or user.role == "umu" and syllabus.creator != user %}
                <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'approved_umu' %}" class="inline-flex items-center gap-2">
                  {% csrf_token %}
                  <input type="text" name="comment" placeholder="Комментарий" class="border rounded px-2 py-1 text-sm">
                  <button class="btn-primary">Финально утвердить</button>
                </form>
                <form method="post" action="{% url 'syllabus_change_status' syllabus.pk 'rejected' %}" class="inline-flex items-center gap-2">
                  {% csrf_token %}
                  <input type="text" name="comment" placeholder="Причина отклонения" class="border rounded px-2 py-1 text-sm" required>
                  <button class="btn-secondary">Отклонить</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-slate-500">Нет заявок на согласовании.</p>
    {% endif %}
  </div>
{% endif %}
  </div>
  <aside class="dashboard__aside">
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Объявления</h2>
        <span class="text-sm text-slate-500">Все</span>
      </div>
      <div class="space-y-3 text-sm text-slate-600">
        <div class="rounded-lg border border-slate-200/70 bg-white/80 p-3">
          Публикаций пока нет. Новые объявления появятся здесь.
        </div>
        <div class="rounded-lg border border-slate-200/70 bg-white/80 p-3">
          Следите за новостями кафедры и расписанием.
        </div>
      </div>
    </div>
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Уведомления</h2>
      </div>
      <div class="rounded-lg border border-slate-200/70 bg-white/80 p-3 text-sm text-slate-600">
        Здесь будут напоминания по задачам, дедлайнам и статусам согласования.
      </div>
    </div>
  </aside>
</div>
{% endblock %}
